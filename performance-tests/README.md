# JMeter Performance Test Suite for Can Cache / Can Cache JMeter Performans Test Paketi

This document is intentionally bilingual. Every English section is immediately followed by its Turkish counterpart so that
all contributors can follow the same structure without switching files.

Bu doküman kasıtlı olarak iki dillidir. Tüm İngilizce bölümlerin hemen ardından aynı başlığın Türkçe açıklaması gelir;
böylece katkıda bulunan herkes dosya değiştirmeden aynı yapıyı takip edebilir.

---

## Table of Contents / İçindekiler

1. [Overview / Genel Bakış](#overview--genel-bakış)
2. [Repository Layout / Depo Yapısı](#repository-layout--depo-yapısı)
3. [Prerequisites / Ön Gereksinimler](#prerequisites--ön-gereksinimler)
4. [Building the Custom Sampler / Özel Samplerı Derlemek](#building-the-custom-sampler--özel-samplerı-derlemek)
5. [Configuration Options / Konfigürasyon Seçenekleri](#configuration-options--konfigürasyon-seçenekleri)
6. [Running the Plans / Planları Çalıştırmak](#running-the-plans--planları-çalıştırmak)
7. [Result Files & Analysis / Sonuç Dosyaları ve Analizi](#result-files--analysis--sonuç-dosyaları-ve-analizi)
8. [Troubleshooting / Sorun Giderme](#troubleshooting--sorun-giderme)
9. [Advanced Usage / İleri Seviye Kullanım](#advanced-usage--ileri-seviye-kullanım)

---

## Overview / Genel Bakış

The `performance-tests` directory hosts the non-functional performance and load tests for the Can Cache project. Apache JMeter
plans simulate realistic cache workloads (set, get, delete) against a cancached-compatible TCP endpoint to validate throughput,
latency and stability targets defined in the non-functional requirements (NFR) documents.

`performance-tests` dizini, Can Cache projesi için fonksiyonel olmayan performans ve yük testlerini barındırır. Apache JMeter
planları cancached uyumlu TCP uç noktasına karşı gerçekçi önbellek iş yüklerini (set, get, delete) taklit ederek NFR
(non-functional requirement) dokümanlarında tanımlanan throughput, gecikme ve kararlılık hedeflerini doğrular.

---

## Repository Layout / Depo Yapısı

| Path | Purpose |
| --- | --- |
| `performance-tests/jmeter/` | JMeter test plans (`.jmx`) grouped by workload profile. |
| `performance-tests/nfr/` | Non-functional requirements explaining target percentiles, success thresholds and escalation paths. |
| `performance-tests/java-sampler/` | Source code for the custom Java sampler that speaks the Can Cache wire protocol. |
| `performance-tests/results/` | Default output folder for `.jtl` result logs generated by test executions. |
| `performance-tests/run-local.sh` | Script that orchestrates local or Docker-based executions, wiring prerequisites automatically. |
| `performance-tests/run-docker.sh` | Helper script that launches a dedicated Docker container with JMeter pre-installed. |

| Yol | Amaç |
| --- | --- |
| `performance-tests/jmeter/` | İş yükü profillerine göre gruplanmış JMeter test planları (`.jmx`). |
| `performance-tests/nfr/` | Hedef yüzdelikleri, başarı eşikleri ve eskalasyon adımlarını açıklayan NFR dokümanları. |
| `performance-tests/java-sampler/` | Can Cache tel protokolünü konuşan özel Java sampler kaynak kodu. |
| `performance-tests/results/` | Test çalıştırmalarıyla üretilen `.jtl` sonuç günlüklerinin varsayılan çıkış klasörü. |
| `performance-tests/run-local.sh` | Ön gereksinimleri otomatik ayarlayarak yerel veya Docker tabanlı çalıştırmaları yöneten betik. |
| `performance-tests/run-docker.sh` | JMeter kurulu özel bir Docker konteynerini başlatan yardımcı betik. |

---

## Prerequisites / Ön Gereksinimler

1. **Apache JMeter 5.6+** installed locally *or* Docker access when using the provided scripts.
2. **Running Can Cache instance** that exposes the cancached TCP port (default `127.0.0.1:11211`). Use `./mvnw quarkus:dev`
   for development or follow the main project README for packaged deployments.
3. **Java Development Kit (JDK) 17 or newer** to compile the custom sampler via Maven.
4. **Maven Wrapper** (already in the repository) or a local Maven installation if you prefer manual builds.
5. *(Optional)* **GNUplot** or spreadsheet software to visualise `.jtl` files once the tests finish.

1. Yerelde kurulu **Apache JMeter 5.6+** *veya* sağlanan betikleri kullanırken erişilebilir Docker ortamı.
2. Cancached TCP portunu açan **çalışır durumda bir Can Cache örneği** (varsayılan `127.0.0.1:11211`). Geliştirme için
   `./mvnw quarkus:dev` komutunu, paketli dağıtım için ana README'deki adımları kullanın.
3. Maven ile özel sampler'ı derlemek için **Java Geliştirme Kiti (JDK) 17 veya üzeri**.
4. Depoda bulunan **Maven Wrapper** veya manuel derlemeyi tercih ediyorsanız yerel Maven kurulumu.
5. *(Opsiyonel)* Testler tamamlandığında `.jtl` dosyalarını görselleştirmek için **GNUplot** veya elektronik tablo yazılımı.

---

## Building the Custom Sampler / Özel Samplerı Derlemek

The JMeter plans rely on a purpose-built Java sampler that implements the Can Cache protocol. Build it once before executing any
plan so that JMeter can load the generated JAR.

JMeter planları, Can Cache protokolünü uygulayan özel bir Java sampler'a dayanır. JMeter'ın üretilen JAR dosyasını yükleyebilmesi
için planları çalıştırmadan önce bir kez derleyin.

```bash
./mvnw -f performance-tests/java-sampler/pom.xml package
```

The build produces `performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar`. Add it to JMeter's
classpath using the `JMETER_ADD_CLASSPATH` environment variable:

Derleme işlemi `performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar` dosyasını üretir. Bu JAR'ı
JMeter classpath'ine `JMETER_ADD_CLASSPATH` ortam değişkeniyle ekleyin:

```bash
export JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar"
```

Instead of exporting globally, you can scope the variable to a single command:

Değişkeni kalıcı olarak export etmek yerine tek bir komutta kullanabilirsiniz:

```bash
JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar" \
  jmeter -n -t performance-tests/jmeter/can-cache-small.jmx
```

The `run-local.sh` script checks for the JAR, automatically builds it when missing, and prints the absolute path of the
resulting artefact so you can add it to custom JMeter setups, provided the Maven wrapper is executable.

`run-local.sh` betiği JAR dosyasını denetler, eksikse Maven wrapper çalıştırılabilir olduğu sürece otomatik olarak derler ve
ortaya çıkan artefaktın mutlak yolunu özel JMeter kurulumlarına ekleyebilmeniz için gösterir.

---

## Configuration Options / Konfigürasyon Seçenekleri

Common runtime properties can be adjusted through either environment variables or `-J` flags passed to JMeter. Defaults are
tuned for local smoke testing and should be overridden for production-like scenarios.

Sık kullanılan çalışma zamanı özellikleri ortam değişkenleri veya JMeter'a verilen `-J` bayrakları aracılığıyla ayarlanabilir.
Varsayılanlar yerel smoke testleri için optimize edilmiştir; üretime benzer senaryolarda değiştirilmelidir.

| Property / Özellik | Description / Açıklama | Default / Varsayılan | Override |
| --- | --- | --- | --- |
| `targetHost` | Can Cache node hostname or IP / Can Cache düğümünün host adı veya IP'si | `127.0.0.1` | `-JtargetHost=10.0.0.5` or `TARGET_HOST=...` |
| `targetPort` | Cancached TCP port / Cancached TCP portu | `11211` | `-JtargetPort=11211` |
| `ttlSeconds` | TTL applied to `set` operations / `set` işlemlerine uygulanan TTL | `60` | `-JttlSeconds=120` |
| `payloadSize` | Payload size in bytes / Payload boyutu (byte) | Plan specific | `-JpayloadSize=1024` |
| `payloadSizes` | Comma-separated payload sizes cycled or randomised / Virgülle ayrılmış ve döngüsel veya rastgele seçilen payload boyutları | `64,512,2048,8192` | `-JpayloadSizes=128,512,2048` |
| `payloadSelection` | Selection strategy for `payloadSizes` (`cycle`/`random`) / `payloadSizes` için seçim stratejisi (`cycle`/`random`) | `cycle` | `-JpayloadSelection=random` |
| `durationSeconds` | Thread group duration / Thread grubu süresi | Plan specific | `-JdurationSeconds=300` |
| `connectTimeoutMillis` | Socket connect timeout / Socket bağlantı zaman aşımı | `1000` | `-JconnectTimeoutMillis=500` |
| `readTimeoutMillis` | Socket read timeout / Socket okuma zaman aşımı | `3000` | `-JreadTimeoutMillis=1500` |
| `threads` | Number of virtual users / Sanal kullanıcı sayısı | Plan specific | `-Jthreads=50` |

---

## Running the Plans / Planları Çalıştırmak

### Using the Local Wrapper Script / Yerel Betiği Kullanma

```bash
./performance-tests/run-local.sh <profile> [-- <additional JMeter args>]
```

Example:

Örnek:

```bash
TARGET_HOST=192.168.1.20 ./performance-tests/run-local.sh medium -- -JdurationSeconds=300
```

* The script builds the sampler when required, ensures the results folder exists, and prefers a locally installed JMeter binary.
* When the `jmeter` command is not found, it falls back to the official Docker image (`justb4/jmeter`).
* Results are written to `performance-tests/results/<profile>-<timestamp>.jtl` unless you override `resultFile`.

* Betik gerekirse sampler'ı derler, sonuç klasörünü oluşturur ve yerel JMeter ikilisini kullanmayı tercih eder.
* `jmeter` komutu bulunamazsa resmi Docker imajına (`justb4/jmeter`) geri döner.
* `resultFile` özelliğini değiştirmedikçe sonuçlar `performance-tests/results/<profil>-<zaman-damgası>.jtl` dosyasına yazılır.

### Direct JMeter CLI / JMeter CLI ile Doğrudan Çalıştırma

```bash
JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar" \
  jmeter -n \
  -t performance-tests/jmeter/can-cache-small.jmx \
  -l performance-tests/results/can-cache-small.jtl \
  -JtargetHost=127.0.0.1 \
  -JtargetPort=11211
```

Adjust the plan (`can-cache-small.jmx`) to match the desired workload. Profiles include `small`, `medium`, `large`, and `xl`.

İş yükünüzle uyumlu olması için plan adını (`can-cache-small.jmx`) değiştirin. Mevcut profiller `small`, `medium`, `large` ve
`xl`'dir.

### Running via Docker Only / Yalnızca Docker ile Çalıştırma

If you prefer an isolated environment, use the Docker helper:

İzolasyon tercih ediyorsanız Docker yardımcı betiğini kullanın:

```bash
./performance-tests/run-docker.sh medium
```

It binds the current repository into the container, builds the sampler if required, and places results back into the local
`performance-tests/results/` directory.

Depoyu konteynıra bağlar, gerekirse sampler'ı derler ve sonuçları yerel `performance-tests/results/` dizinine geri yazar.

---

## Result Files & Analysis / Sonuç Dosyaları ve Analizi

Each run generates a `.jtl` log containing raw sample data. Combine it with the matching NFR document to decide whether the run
meets expectations.

Her çalıştırma ham örnek verileri içeren `.jtl` logu üretir. Çalışmanın beklentileri karşılayıp karşılamadığını belirlemek için
ilgili NFR dokümanıyla birlikte değerlendirin.

Recommended workflow / Önerilen iş akışı:

1. Import the `.jtl` file into JMeter GUI, JMeter Plugins CMD, or a spreadsheet to compute percentile latencies.
2. Compare metrics (p50/p95/p99 latency, throughput, error rate) with the NFR acceptance criteria.
3. Archive the `.jtl` file together with a short summary describing environment, configuration overrides and observed results.

1. `.jtl` dosyasını JMeter GUI, JMeter Plugins CMD veya bir elektronik tabloya aktararak yüzdelik gecikmeleri hesaplayın.
2. Metikleri (p50/p95/p99 gecikme, throughput, hata oranı) NFR kabul kriterleriyle karşılaştırın.
3. `.jtl` dosyasını ortam, yapılan konfigürasyon değişiklikleri ve gözlemlenen sonuçları açıklayan kısa bir özetle birlikte
   arşivleyin.

---

## Troubleshooting / Sorun Giderme

| Symptom / Belirti | Cause / Neden | Fix / Çözüm |
| --- | --- | --- |
| `ClassNotFoundException` for the sampler | JAR not on JMeter classpath | Rebuild the sampler and set `JMETER_ADD_CLASSPATH`. |
| High connection errors | Target host unreachable or TLS/Firewall issues | Verify connectivity with `telnet` or `nc`, review firewall rules. |
| Immediate test termination | Missing Java runtime when using Docker | Ensure Docker image downloads correctly and includes JDK 17+. |
| Empty `.jtl` file | Wrong result path or permissions | Confirm `-l` path exists and the user can write to it. |

| Belirti | Neden | Çözüm |
| --- | --- | --- |
| Sampler için `ClassNotFoundException` | JAR JMeter classpath'inde değil | Sampler'ı yeniden derleyip `JMETER_ADD_CLASSPATH` ayarlayın. |
| Yüksek bağlantı hataları | Hedef host erişilebilir değil veya TLS/Güvenlik duvarı sorunu | `telnet` veya `nc` ile erişimi doğrulayın, güvenlik duvarı kurallarını kontrol edin. |
| Test hemen sonlanıyor | Docker kullanırken Java runtime eksik | Docker imajının doğru indirildiğinden ve JDK 17+ içerdiğinden emin olun. |
| Boş `.jtl` dosyası | Yanlış sonuç yolu veya izin sorunu | `-l` parametresiyle verilen yolun varlığını ve yazma iznini doğrulayın. |

---

## Advanced Usage / İleri Seviye Kullanım

### Distributed JMeter / Dağıtık JMeter

To scale beyond a single machine, configure JMeter in distributed mode. Package the sampler JAR and copy it to every server,
then set `run-local.sh` to contact remote engines by passing `-R host1,host2` through the `--` argument separator.

Tek makinenin ötesine ölçeklemek için JMeter'ı dağıtık modda yapılandırın. Sampler JAR dosyasını paketleyip tüm sunuculara
kopyalayın, ardından `--` argüman ayırıcısı üzerinden `-R host1,host2` geçirerek `run-local.sh` betiğinin uzak motorlara
bağlanmasını sağlayın.

### Parameterising Test Data / Test Verisini Parametreleştirme

Store CSV datasets under `performance-tests/data/` and refer to them from the JMeter CSV Data Set Config element. Commit only
synthetic or anonymised datasets.

CSV veri setlerini `performance-tests/data/` dizininde saklayın ve JMeter CSV Data Set Config elemanından referans verin. Yalnız
sentetik veya anonimleştirilmiş veri setlerini commit edin.

### Diversifying Payload Sizes / Payload Boyutlarını Çeşitlendirme

The Java sampler now supports comma-separated payload size lists and selection strategies. Define `-JpayloadSizes=64,1024,8192`
to exercise small and large objects in a single run. Change `-JpayloadSelection=random` to pick a random size per iteration,
otherwise the sampler cycles deterministically.

Java sampler artık virgülle ayrılmış payload boyutu listeleri ve seçim stratejilerini destekliyor. Tek bir koşuda hem küçük hem
de büyük objeleri denemek için `-JpayloadSizes=64,1024,8192` parametresini kullanabilirsiniz. `-JpayloadSelection=random`
yapıldığında her iterasyonda rastgele boyut seçilir; aksi halde sampler belirli bir sırayla döner.

### CI Integration / CI Entegrasyonu

Add a dedicated pipeline step that executes `run-local.sh` with the desired profile and publishes the resulting `.jtl` file as an
artifact. Use the exit code to fail builds when NFR thresholds are not met.

`run-local.sh` betiğini istediğiniz profille çalıştıran ve ortaya çıkan `.jtl` dosyasını artefakt olarak yayımlayan ayrı bir
pipeline adımı ekleyin. NFR eşikleri karşılanmadığında derlemeleri başarısız yapmak için çıkış kodunu kullanın.

---

By following the guidelines above you can execute consistent, reproducible performance tests for Can Cache and evaluate the
system against clearly defined non-functional goals.

Yukarıdaki yönergeleri izleyerek Can Cache için tutarlı ve tekrarlanabilir performans testleri çalıştırabilir ve sistemi açıkça
tanımlanmış fonksiyonel olmayan hedeflere göre değerlendirebilirsiniz.
