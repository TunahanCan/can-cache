# JMeter Load Test Suite for Can Cache / Can Cache JMeter Yük Testi Paketi

This README provides detailed instructions in both English and Turkish. English sections come first, followed by their Turkish counterparts to keep guidance accessible for all contributors.

Bu README hem İngilizce hem de Türkçe ayrıntılı talimatlar içerir. İngilizce bölümler önce gelir, ardından kolay erişim için aynı başlıkların Türkçe karşılıkları sunulur.

---

## English Guide

### Overview

The `performance-tests` directory hosts the non-functional performance and load testing assets for the Can Cache project. Test plans are implemented with Apache JMeter and exercise a cancached-compatible TCP endpoint by issuing realistic cache operations (`set`, `get`, `delete`). Each plan targets a specific workload profile and is paired with measurable non-functional requirements (NFRs) that define success criteria.

### Repository Layout

| Path | Purpose |
| --- | --- |
| `performance-tests/jmeter/` | JMeter test plans (`.jmx`) for each workload profile. |
| `performance-tests/nfr/` | Non-functional requirement definitions (`.md`) that explain latency, throughput, and error budgets. |
| `performance-tests/java-sampler/` | Source code for the custom Java sampler used by the plans. |
| `performance-tests/results/` | Output directory for `.jtl` result files generated by JMeter runs. |
| `performance-tests/run-local.sh` | Helper script that orchestrates local or containerised execution of the plans. |

### Prerequisites

1. **Apache JMeter** 5.6 or newer installed locally, or Docker available if you plan to run through the helper script.
2. **Running Can Cache instance** listening on the cancached port (default `127.0.0.1:11211`). Use `./mvnw quarkus:dev` for development or follow the main project README to run the packaged JAR.
3. **Java Development Kit (JDK) 17+** to compile the custom sampler via Maven.
4. *(Optional)* Writable `performance-tests/results/` directory if you want to persist `.jtl` result files. The location can be overridden with JMeter properties.

### Building the Java Sampler

The JMeter plans depend on a dedicated Java sampler located under `performance-tests/java-sampler`. Build it once and place the generated JAR on the JMeter classpath.

```bash
./mvnw -f performance-tests/java-sampler/pom.xml package
```

The build produces `performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar`. Make sure JMeter can find this JAR:

```bash
export JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar"
```

You may also prefix a single command instead of exporting globally:

```bash
JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar" jmeter ...
```

The helper script `performance-tests/run-local.sh` checks for the JAR and builds it automatically if missing, provided the Maven wrapper is available.

### Running Test Plans Manually

Each workload profile has a dedicated `.jmx` file under `performance-tests/jmeter` and an accompanying NFR file under `performance-tests/nfr`. Run a plan with the JMeter CLI after configuring the sampler classpath:

```bash
JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar" \
  jmeter -n \
  -t performance-tests/jmeter/can-cache-small.jmx \
  -l performance-tests/results/can-cache-small.jtl \
  -JtargetHost=127.0.0.1 \
  -JtargetPort=11211
```

Commonly used override properties:

| Property | Description | Default |
| --- | --- | --- |
| `targetHost` | Hostname or IP of the Can Cache node under test. | `127.0.0.1` |
| `targetPort` | TCP port of the cancached endpoint. | `11211` |
| `ttlSeconds` | TTL assigned to the `set` command. | `60` |
| `connectTimeoutMillis` | Socket connect timeout in milliseconds. | `1000` |
| `readTimeoutMillis` | Socket read timeout in milliseconds. | `3000` |
| `keyPrefix` | Prefix for generated cache keys. | `perf-` |
| `payloadSize` | Size of generated payload in bytes (plan-specific default). | varies |
| `durationSeconds` | Total runtime of the thread group (plan-specific default). | varies |
| `resultFile` | Output `.jtl` path for aggregated metrics. | `performance-tests/results/can-cache-<profile>.jtl` |

### Using the Helper Script

To simplify local runs, use the provided wrapper script. It creates the results directory, manages classpath wiring, and falls back to a Dockerised JMeter image when the binary is not installed locally.

```bash
./performance-tests/run-local.sh small
```

Pass a different profile (`small`, `medium`, `large`, `xl`) as the first argument. Additional JMeter flags can be forwarded after `--`:

```bash
TARGET_HOST=192.168.10.15 ./performance-tests/run-local.sh medium -- -JdurationSeconds=180
```

Environment variables recognised by the script:

| Variable | Effect |
| --- | --- |
| `TARGET_HOST` | Overrides `targetHost`. |
| `TARGET_PORT` | Overrides `targetPort`. |
| `TTL_SECONDS` | Overrides `ttlSeconds`. |
| `PAYLOAD_SIZE` | Overrides `payloadSize`. |
| `DURATION_SECONDS` | Overrides `durationSeconds`. |

### Load Profiles

| Profile | Threads | Ramp-up | Duration | Payload | Think time | Goal |
| --- | --- | --- | --- | --- | --- | --- |
| Small (`can-cache-small.jmx`) | 5 | 10 s | 120 s | 64 B | 100 ms | Baseline health & smoke test under light load. |
| Medium (`can-cache-medium.jmx`) | 20 | 30 s | 300 s | 128 B | 75 ms | Mid-tier concurrency to validate scaling behaviour. |
| Large (`can-cache-large.jmx`) | 50 | 60 s | 600 s | 256 B | 50 ms | High concurrency stressing CPU and network queues. |
| Extra Large (`can-cache-xl.jmx`) | 100 | 90 s | 900 s | 512 B | 25 ms | Saturation-level workload for capacity planning. |

Consult the matching NFR documents for latency/error budgets, success thresholds, and recovery guidelines.

### Tips for Analysis

* Inspect `.jtl` files with JMeter GUI, BlazeMeter, or command-line parsers to calculate percentiles and error rates.
* Compare observed metrics with the NFR acceptance criteria to determine pass/fail status.
* Version-control important result files or summaries under `performance-tests/results/` with timestamped filenames for traceability.

---

## Türkçe Rehber

### Genel Bakış

`performance-tests` dizini, Can Cache projesi için hazırlanan fonksiyonel olmayan performans ve yük testi varlıklarını barındırır. Test planları Apache JMeter ile yazılmıştır ve gerçekçi önbellek işlemlerini (`set`, `get`, `delete`) çalıştırarak cancached uyumlu TCP uç noktasını sınar. Her plan belirli bir iş yükünü hedefler ve başarı kriterlerini tanımlayan ölçülebilir NFR (non-functional requirement) dokümanlarıyla eşleştirilmiştir.

### Depo Yapısı

| Yol | Amaç |
| --- | --- |
| `performance-tests/jmeter/` | Her iş yükü profiline ait JMeter test planları (`.jmx`). |
| `performance-tests/nfr/` | Gecikme, throughput ve hata bütçelerini açıklayan NFR tanımları (`.md`). |
| `performance-tests/java-sampler/` | Planların kullandığı özel Java sampler kaynak kodu. |
| `performance-tests/results/` | JMeter çalıştırmaları sırasında üretilen `.jtl` sonuç dosyalarının dizini. |
| `performance-tests/run-local.sh` | Planları yerelde veya konteyner içinde çalıştırmayı kolaylaştıran betik. |

### Ön Gereksinimler

1. Yerelde kurulu **Apache JMeter 5.6+** veya betiği Docker üzerinden çalıştırmak için Docker erişimi.
2. Cancached portunu dinleyen **çalışır durumda bir Can Cache örneği** (varsayılan `127.0.0.1:11211`). Geliştirme için `./mvnw quarkus:dev` komutunu veya ana proje README'sindeki paketli JAR talimatlarını kullanın.
3. Özel sampler'ı Maven ile derlemek için **Java Geliştirme Kiti (JDK) 17+**.
4. *(Opsiyonel)* `.jtl` sonuç dosyalarını kalıcı olarak saklamak için yazılabilir `performance-tests/results/` dizini. Konum JMeter özellikleriyle değiştirilebilir.

### Java Sampler'ı Derleme

JMeter planları `performance-tests/java-sampler` altındaki özel Java sampler'a bağlıdır. Bir kez derleyip ortaya çıkan JAR dosyasını JMeter classpath'ine ekleyin.

```bash
./mvnw -f performance-tests/java-sampler/pom.xml package
```

Derleme `performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar` dosyasını üretir. JMeter'ın bu JAR'ı görebildiğinden emin olun:

```bash
export JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar"
```

Tek bir komutu çalıştırırken de değişkeni export etmeden kullanabilirsiniz:

```bash
JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar" jmeter ...
```

`performance-tests/run-local.sh` betiği JAR dosyasını kontrol eder ve yoksa Maven wrapper mevcut olduğu sürece otomatik derler.

### Test Planlarını Elle Çalıştırma

Her iş yükü profili `performance-tests/jmeter` altında ayrı bir `.jmx` dosyasına, `performance-tests/nfr` altında da ilgili bir NFR dosyasına sahiptir. Sampler classpath'i ayarlandıktan sonra planı JMeter CLI ile çalıştırın:

```bash
JMETER_ADD_CLASSPATH="$(pwd)/performance-tests/java-sampler/target/can-cache-jmeter-sampler-0.0.1-SNAPSHOT.jar" \
  jmeter -n \
  -t performance-tests/jmeter/can-cache-small.jmx \
  -l performance-tests/results/can-cache-small.jtl \
  -JtargetHost=127.0.0.1 \
  -JtargetPort=11211
```

Sık kullanılan değiştirilebilir özellikler:

| Özellik | Açıklama | Varsayılan |
| --- | --- | --- |
| `targetHost` | Test edilecek Can Cache düğümünün host adı veya IP adresi. | `127.0.0.1` |
| `targetPort` | Cancached uç noktasının TCP portu. | `11211` |
| `ttlSeconds` | `set` komutuna atanacak TTL değeri. | `60` |
| `connectTimeoutMillis` | Socket bağlantı zaman aşımı (ms). | `1000` |
| `readTimeoutMillis` | Socket okuma zaman aşımı (ms). | `3000` |
| `keyPrefix` | Üretilen cache anahtarları için önek. | `perf-` |
| `payloadSize` | Oluşturulan payload boyutu (byte cinsinden, plana göre değişir). | değişken |
| `durationSeconds` | Thread grubunun toplam çalışma süresi (plana özgü varsayılan). | değişken |
| `resultFile` | Özet metriklerin yazılacağı `.jtl` dosya yolu. | `performance-tests/results/can-cache-<profile>.jtl` |

### Yardımcı Betiği Kullanma

Yerel çalıştırmaları sadeleştirmek için sağlanan betiği kullanabilirsiniz. Sonuç dizinini oluşturur, classpath ayarlarını yönetir ve yerel JMeter ikilisi yoksa Dockerized JMeter imajını kullanır.

```bash
./performance-tests/run-local.sh small
```

İlk argümana farklı bir profil (`small`, `medium`, `large`, `xl`) verin. `--` sonrasına ek JMeter parametreleri iletilir:

```bash
TARGET_HOST=192.168.10.15 ./performance-tests/run-local.sh medium -- -JdurationSeconds=180
```

Betik tarafından tanınan ortam değişkenleri:

| Değişken | Etki |
| --- | --- |
| `TARGET_HOST` | `targetHost` değerini değiştirir. |
| `TARGET_PORT` | `targetPort` değerini değiştirir. |
| `TTL_SECONDS` | `ttlSeconds` değerini değiştirir. |
| `PAYLOAD_SIZE` | `payloadSize` değerini değiştirir. |
| `DURATION_SECONDS` | `durationSeconds` değerini değiştirir. |

### Yük Profilleri

| Profil | Thread | Ramp-up | Süre | Payload | Düşünme süresi | Amaç |
| --- | --- | --- | --- | --- | --- | --- |
| Small (`can-cache-small.jmx`) | 5 | 10 sn | 120 sn | 64 B | 100 ms | Hafif yük altında sağlık/smoke testi. |
| Medium (`can-cache-medium.jmx`) | 20 | 30 sn | 300 sn | 128 B | 75 ms | Ölçeklenme davranışını doğrulayan orta seviye eşzamanlılık. |
| Large (`can-cache-large.jmx`) | 50 | 60 sn | 600 sn | 256 B | 50 ms | CPU ve ağ kuyruklarını zorlayan yüksek eşzamanlılık. |
| Extra Large (`can-cache-xl.jmx`) | 100 | 90 sn | 900 sn | 512 B | 25 ms | Kapasite planlaması için doyum seviyesine yakın iş yükü. |

Her profille ilişkili NFR dokümanlarını inceleyerek gecikme/hata bütçeleri, başarı eşikleri ve operasyonel önlemler hakkında bilgi edinin.

### Analiz İçin İpuçları

* `.jtl` dosyalarını JMeter GUI, BlazeMeter veya komut satırı analiz araçlarıyla inceleyerek yüzdelikler ve hata oranlarını hesaplayın.
* Gözlemlenen metrikleri NFR kabul kriterleriyle karşılaştırarak geçme/kalma durumunu belirleyin.
* Önemli sonuç dosyalarını veya özetleri zaman damgalı dosya adlarıyla `performance-tests/results/` dizininde sürümleyin.

